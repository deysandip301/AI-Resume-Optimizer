name: CD - Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI - Quality, Security & Build"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    name: Deploy to DigitalOcean Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      # 1. Checkout the latest code (for manifests)
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Install doctl CLI for DigitalOcean API access
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      # 3. Get Kubernetes credentials for kubectl
      - name: Get Kubernetes Credentials
        run: doctl kubernetes cluster kubeconfig save ${{ secrets.DIGITALOCEAN_CLUSTER_NAME }}

      # 4. Deploy to Kubernetes (apply manifests)
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      # 5. Wait for deployment to be ready (basic check)
      - name: Wait for Deployment
        run: |
          kubectl rollout status deployment/ats-matcher --timeout=120s

      # 6. Basic DAST: Check health endpoint
      - name: DAST - Health Check
        run: |
          # Get service external IP (wait up to 5 min)
          for i in {1..30}; do
            EXTERNAL_IP=$(kubectl get service ats-matcher-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || true)
            if [ -n "$EXTERNAL_IP" ]; then
              echo "Service available at: http://$EXTERNAL_IP"
              break
            fi
            echo "Waiting for LoadBalancer IP... ($i/30)"
            sleep 10
          done
          # Health check
          if [ -n "$EXTERNAL_IP" ]; then
            curl -sf "http://$EXTERNAL_IP/health" || exit 1
          else
            echo "No external IP found, skipping health check."
            exit 1
          fi