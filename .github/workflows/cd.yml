name: CD - Deploy & DAST
on:
  workflow_run:
    workflows: ["CI - Quality, Security & Build"]
    types: [completed]
    branches: [main]

jobs:
  # Deploy to DigitalOcean Kubernetes
  deploy-digitalocean:
    name: Deploy to DigitalOcean (Bangalore)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Login to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Build and Push Image
        run: |
          IMAGE=${{ secrets.DIGITALOCEAN_REGISTRY }}/ats-matcher
          docker build -t $IMAGE:${{ github.sha }} -t $IMAGE:latest .
          docker push $IMAGE:${{ github.sha }}
          docker push $IMAGE:latest

      - name: Get Kubernetes Credentials
        run: |
          doctl kubernetes cluster kubeconfig save ${{ secrets.DIGITALOCEAN_CLUSTER_NAME }}

      - name: Grant Cluster Access to Registry
        run: |
          # Connect the K8s cluster to the container registry
          doctl kubernetes cluster registry add ${{ secrets.DIGITALOCEAN_CLUSTER_NAME }} || true

      - name: Update Deployment Image
        run: |
          IMAGE=${{ secrets.DIGITALOCEAN_REGISTRY }}/ats-matcher
          sed -i "s|image: .*ats-matcher.*|image: $IMAGE:${{ github.sha }}|" k8s/deployment.yaml
          cat k8s/deployment.yaml

      - name: Deploy to Kubernetes
        run: |
          # Delete old deployment first for clean start
          kubectl delete deployment ats-matcher --ignore-not-found=true
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          
          # Wait with debug output
          echo "Waiting for deployment..."
          for i in {1..60}; do
            STATUS=$(kubectl get deployment ats-matcher -o jsonpath='{.status.availableReplicas}' 2>/dev/null || echo "0")
            if [ "$STATUS" = "1" ]; then
              echo "✅ Deployment ready!"
              break
            fi
            echo "Attempt $i/60 - Checking pod status..."
            kubectl get pods -l app=ats-matcher
            sleep 5
          done
          
          # Final check and debug if failed
          kubectl rollout status deployment/ats-matcher --timeout=60s || {
            echo "=== Deployment Failed - Debug Info ==="
            kubectl get pods -l app=ats-matcher -o wide
            kubectl describe pods -l app=ats-matcher
            kubectl logs -l app=ats-matcher --tail=100 || true
            exit 1
          }

      - name: Get Service URL
        run: |
          echo "Waiting for external IP..."
          for i in {1..30}; do
            EXTERNAL_IP=$(kubectl get service ats-matcher-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || true)
            if [ -n "$EXTERNAL_IP" ]; then
              echo "✅ Service available at: http://$EXTERNAL_IP"
              echo "SERVICE_URL=http://$EXTERNAL_IP" >> $GITHUB_ENV
              break
            fi
            echo "Waiting for LoadBalancer IP... ($i/30)"
            sleep 10
          done

      - name: DAST - API Security Testing
        run: |
          if [ -z "$SERVICE_URL" ]; then
            echo "Using port-forward..."
            kubectl port-forward service/ats-matcher-service 8000:80 &
            sleep 5
            SERVICE_URL="http://localhost:8000"
          fi
          
          echo "=== DAST against $SERVICE_URL ==="
          curl -sf "$SERVICE_URL/health" | jq .
          curl -sf -X POST "$SERVICE_URL/analyze/text" \
            -H "Content-Type: application/json" \
            -d '{"text": "python developer", "keywords": ["python", "aws"]}' | jq .
          echo "✅ DAST completed!"
