name: CD - Deploy & DAST
on:
  workflow_run:
    workflows: ["CI - Quality, Security & Build"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure Kubernetes Context
        # WHY: Connects to your K8s cluster for deployment
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig.yaml
          export KUBECONFIG=kubeconfig.yaml

      - name: Deploy to Kubernetes
        # WHY: Applies deployment and service manifests to the cluster
        run: |
          export KUBECONFIG=kubeconfig.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl rollout status deployment/ats-matcher --timeout=120s

      - name: Cleanup
        if: always()
        run: rm -f kubeconfig.yaml

  dast:
    name: Dynamic Application Security Testing
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Deployment
        run: sleep 30

      - name: DAST Health Check
        # WHY: Verifies the deployed application is responding
        run: |
          # Replace with your actual service URL
          SERVICE_URL="${{ secrets.SERVICE_URL }}"
          if [ -z "$SERVICE_URL" ]; then
            echo "SERVICE_URL not set, using placeholder"
            SERVICE_URL="http://localhost:8000"
          fi
          echo "Testing endpoint: $SERVICE_URL/health"
          # This would be replaced with actual OWASP ZAP or similar in production
          curl -f "$SERVICE_URL/health" || echo "DAST: Endpoint test (placeholder for ZAP scan)"

      - name: DAST Security Scan (Placeholder)
        # WHY: Scans running application for runtime vulnerabilities
        # In production, use: zaproxy/action-full-scan@v0.7.0
        run: |
          echo "=== DAST Security Scan ==="
          echo "In production, this step would run OWASP ZAP against the live endpoint."
          echo "Example command: zap-full-scan.py -t \$SERVICE_URL -r report.html"
          echo "For SST demo purposes, this is a placeholder showing DAST integration point."
